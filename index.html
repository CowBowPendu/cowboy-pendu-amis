// --- Joindre ou cr√©er la partie ---
function joinOrCreateGame() {
    db.ref("players").once("value").then(snap=>{
        players = snap.val()||[];
        if(!players.some(p=>p.name===player)){
            players.push({name:player,color:playerColor});
            db.ref("players").set(players);
        }
        updatePlayersDisplay();
    });

    db.ref("game").once("value").then(snap=>{
        if(!snap.exists()){
            // nouvelle partie
            currentWord = words[Math.floor(Math.random()*words.length)];
            db.ref("game").set({
                currentWord: currentWord,
                guessedLetters: [],
                attemptsLeft: maxAttempts,
                turnIndex: 0,
                gameOver: false
            });
        } else {
            const data = snap.val();
            currentWord = data.currentWord;
            guessedLetters = data.guessedLetters;
            attemptsLeft = data.attemptsLeft;
            turnIndex = data.turnIndex;
        }
    });
}

// --- Gestion des clics sur lettres ---
function guessLetter(letter){
    db.ref("game").once("value").then(snap=>{
        const game = snap.val();
        if(!game || game.gameOver) return;

        const currentPlayer = players[game.turnIndex];
        if(currentPlayer?.name !== player){
            alert("Ce n'est pas votre tour !");
            return;
        }

        if(game.guessedLetters.includes(letter)) return;

        let updatedLetters = [...game.guessedLetters, letter];
        let updatedAttempts = game.attemptsLeft;
        if(!game.currentWord.includes(letter)) updatedAttempts--;

        let nextTurn = (game.turnIndex + 1) % players.length;
        let gameOver = false;
        if(updatedAttempts<=0 || !game.currentWord.split("").some(l => !updatedLetters.includes(l))) {
            gameOver = true;
        }

        db.ref("game").update({
            guessedLetters: updatedLetters,
            attemptsLeft: updatedAttempts,
            turnIndex: nextTurn,
            gameOver: gameOver
        });
    });
}

// --- D√©sactiver les boutons lettres apr√®s clic ---
function generateLetterButtons(){
    lettersDiv.innerHTML="";
    for(let c=97;c<=122;c++){
        const letter = String.fromCharCode(c);
        const btn = document.createElement("button");
        btn.textContent = letter;
        btn.onclick = () => {
            btn.disabled = true;   // d√©sactive apr√®s clic
            guessLetter(letter);
        };
        lettersDiv.appendChild(btn);
    }
}

// --- Synchronisation temps r√©el ---
db.ref("game").on("value", snap=>{
    const game = snap.val();
    if(!game) return;

    currentWord = game.currentWord;
    guessedLetters = game.guessedLetters;
    attemptsLeft = game.attemptsLeft;
    turnIndex = game.turnIndex;

    displayWord();
    drawHangman(maxAttempts - attemptsLeft);
    turnInfo.textContent = `Tour du joueur ${players[turnIndex]?.name || "?"}`;

    if(game.gameOver){
        if(attemptsLeft<=0){
            animateFall();
            statusDiv.textContent = `üíÄ Partie termin√©e, le mot √©tait "${currentWord}"`;
        } else {
            soundWin.play();
            statusDiv.textContent = `üéâ Partie termin√©e, le mot a √©t√© trouv√© !`;
        }
    }
});
